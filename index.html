<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UTPL - Abanderados 2025</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <!-- ESTILOS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .spinner { border: 4px solid #e2e8f0; border-top: 4px solid #facc15; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <!-- REACT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin></script>
</head>
<body>
    <div id="root">
        <div class="h-screen flex flex-col items-center justify-center text-blue-900">
            <div class="spinner mb-4"></div>
            <h2 class="text-xl font-bold">Iniciando Sistema...</h2>
        </div>
    </div>

    <script type="text/babel" data-presets="env,react">
        const { useState, useMemo, useEffect, useRef } = React;

        // URL DE TU GOOGLE APPS SCRIPT
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwoSbym3cxzdsjzx2qGq75RNhe7P6p_pX5_OrAktMSXJiowE9aVqfZ6EexMVV8p2yj3/exec";

        const safeLoadStorage = (key) => {
            try {
                const item = localStorage.getItem(key);
                return item ? new Set(JSON.parse(item)) : new Set();
            } catch (e) { return new Set(); }
        };

        // --- DIGNIDADES CORREGIDAS (PROTOCOLO) ---
        const getDignity = (pos) => {
            switch(pos) {
                case 1: return "ABANDERADO DEL PABELLÓN NACIONAL";
                case 2: return "PORTAESTANDARTE DE LA CIUDAD";  // Corregido
                case 3: return "PORTAESTANDARTE INSTITUCIONAL";
                case 4: return "1ER ESCOLTA PABELLÓN NACIONAL";
                case 6: return "2DO ESCOLTA PABELLÓN NACIONAL";
                case 7: return "1ER ESCOLTA ESTANDARTE DE LA CIUDAD"; // Corregido
                case 8: return "2DO ESCOLTA ESTANDARTE DE LA CIUDAD"; // Corregido
                case 9: return "1ER ESCOLTA ESTANDARTE INSTITUCIONAL";
                case 10: return "2DO ESCOLTA ESTANDARTE INSTITUCIONAL";
                default: return "ESTUDIANTE";
            }
        };

        // --- ICONOS ---
        const ChairIcon = ({size=24, className="", fill="none"}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 9V6a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v3"/><path d="M3 16a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-5a2 2 0 0 0-4 0v2H7v-2a2 2 0 0 0-4 0Z"/><path d="M5 18v2"/><path d="M19 18v2"/></svg>);
        const Search = ({size=24, className=""}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>);
        const User = ({size=24, className=""}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>);
        const X = ({size=24, className=""}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>);
        const CheckCircle = ({size=24, className="", fill="none"}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m22 4-12 12-4-4"/></svg>);
        const Users = ({size=24, className=""}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>);
        const Calendar = ({size=24, className=""}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>);
        const ArrowLeft = ({size=24, className=""}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>);
        const ChevronRight = ({size=24, className=""}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>);
        const Download = ({size=24, className=""}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>);
        const FileSpreadsheet = ({size=24, className=""}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>);
        const Medal = ({size=24, className=""}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>);

        // --- DATOS ---
        const createRow = (id, school, leftNames, rightNames, hasRector=true) => ({
            id, school, hasRector,
            seatsLeft: leftNames.map((n, i) => ({ id: `${id}-L-${i+1}`, name: n, pos: i+1, dignity: getDignity(i+1) })),
            seatsRight: rightNames.map((n, i) => ({ id: `${id}-R-${i+6}`, name: n, pos: i+6, dignity: getDignity(i+6) }))
        });

        const event1Data = [
            createRow('e1-r1', 'UE San José', 
                ['GALARZA CHONILLO MELISSA THAIMI', 'INTRIAGO ZAMBRANO GABRIEL ADRIAN', 'TARANTO SUAREZ GABRIELA STEFANÍA', 'BARRETO VELIZ JENNIFER PATRICIA'],
                ['MENÉNDEZ PALACIOS RITSI MONSERRATE', 'MARTÍNEZ AMORES OMAYRA KAINA', 'BOCCANEDES BARCIA MADELAINE ISABELLA', 'VEGA PEÑA ANENT KINTIA', 'VILLACIS FRANCO SHARICK NATHALIA']
            ),
            createRow('e1-r2', 'UE Lev Vigostky', 
                ['MEJIA MACÍAS AXEL ARGELIS', 'MENDOZA BUSTAMANTE KARLA ABIGAIL', 'ALONZO INTRIAGO JESÚS AMADO', 'MEDINA ANDRADE LISS NORELLY'],
                ['VILLACRESES ALARCÓN AMY MAITE', 'CATAGUA LOPEZ JOHAN MANUEL', 'VINCES VELEZ HERNY DAVID', 'PINARGOTE PALMA KEVIN XAVIER', 'SALTOS QUIROZ SHERLY MICHEL']
            ),
            createRow('e1-r3', 'UE Olga Meza Santana', 
                ['MENDOZA GARCIA MEDARDO ANTHONIO', 'BAILON CASTILLO JAIRO YAIR', 'PALMA INDACOCHEA AARON JURHELL', 'PILOSO CEDEÑO JEAN POOL'],
                ['CHANCAY ALVARADO SOFIA ALEJANDRA', 'SALINAS DELGADO VICTOR XAVIER', 'ZAMBRANO BORRERO MIA SARAI', 'PICO MUÑOZ CRISTHOPER DAMIAN', 'DELGADO VELEZ GABRIELA NATHALIE']
            ),
            createRow('e1-r4', 'UE Kruger School', 
                ['LOPEZ PINARGOTE LEIDY ZULEIKA', 'VILLALVA GONZÁLEZ DAVID', 'POLANCO BENALCÁZAR FRANKLIN ALEJANDRO', 'SUAREZ QUIROZ STALIN ENRIQUE'],
                ['ALVAREZ ROBLES NAOMI ANAIS', 'MENDOZA BRAVO MICHAEL ALEJANDRO', 'VELEZ MUÑOZ RONALD ESTEVEN', 'BASURTO MIELES ANA MARÍA', 'SIGCHO RIVADENEIRA FABIANA ANTONIA']
            ),
            createRow('e1-r5', 'UE Lev Vigostky (B)', 
                ['PAREDES CHONG CESAR ENRIQUE', 'MANTUANO TOALA DAVID GABRIEL', 'QUIJIJE MOREIRA RAÚL ANDRÉS', 'VACANTE'],
                ['VACANTE', 'VACANTE', 'VACANTE', 'VACANTE', 'VACANTE'], false
            )
        ];

        const event2Data = [
            createRow('e2-r1', 'Academia Naval Jambelí', 
                ['GUILLEN LINO JONATHAN ISAAC', 'VELIZ ZAMBRANO DANNA SAMANTHA', 'RIVERA SANTANA ARIANA SCARLETH', 'MASTERRENA CARRION RAMON REINALDO'],
                ['PIN TUBAY FELIPE MATEO', 'PIN TUBAY FELIPE MATEO (2)', 'VELEZ CEDEÑO EMILY YORIBEL', 'QUIJANO BRAVO FELIPE ALEXANDER', 'QUIJANO BRAVO FELIPE ALEXANDER (2)']
            ),
            createRow('e2-r2', 'UE Luis Arboleda Martinez', 
                ['BURGOS GAVILANEZ NIURKA BEATRIZ', 'MONTES MOREIRA FREDDY YASSIER', 'BAILON CASTILLO JAIRO YAIR', 'NAVARRETE CEDEÑO JOSÉ LEONARDO'],
                ['ANCHUNDIA FLORES PATRICIO GEOVANNY', 'RODRIGUEZ SALMERON EIDAN ADRIAN', 'SUAREZ VELEZ RONNY FABIAN', 'MACIAS ALARCÓN JOEL ANDRÉS', 'VINCES PERÉZ LUIS FERNANDO']
            ),
            createRow('e2-r3', 'UE Tohallí', 
                ['DANNA ISABEL VELASQUEZ PEÑAHERRIETA', 'ROSELYN ANAÍS LOPEZ DELGADO', 'LUISA FERNANDA OTERO CHACON', 'MAHOLY JAMILETH ALAVA DELGADO'],
                ['VALERIA ISABEL CAÑARTE REYES', 'SARA ROMINA PICO ORTIZ', 'GEANELLA ANDREÍNA TUBAY ALVAREZ', 'DARA MADAI SANCHEZ ZALDUMBIDE', 'DAMARIS BELÉN CUSME MENDOZA']
            ),
            createRow('e2-r4', 'UE Camilo Ponce Enrique', 
                ['PALACIOS REYES SOLANGE YISLEY', 'NARANJO CARRASCO ASHLEY ALEXANDRA', 'MIRANDA QUIMIZ ARIANA VALESKA', 'PATA LUCAS JEALENE TAIS'],
                ['FRANCO MACIAS BRITHANY XIOMARA', 'ROSADO SANCHEZ BRITHANY JAMILETH', 'ROLDAN SOZA DOMENICA DAYANNA', 'MERO ALARCON SARA VALENTINA', 'PILLIGUA BASURTO ALIS VICTORIA']
            )
        ];

        const event3Data = [
            createRow('e3-r1', 'UE Fiscal Cinco de Junio', 
                ['SORNOZA ZAMBRANO SHEYLA JEMINA', 'MOREIRA MENDOZA WILSON JOSUE', 'MARCILLO BRAVO KARLA MILEY', 'MACIAS LUGO ELIAN ALEXANDER'],
                ['PIGUAVE PILOZO JOSE ANDRES', 'GUANANGA CUZQUILLO ADRIAN SEBASTIAN', 'RUPERTI SUAREZ DOMENICA IVETTE', 'SORIANO BURBANO ILEANA NINETTE', 'CEVALLOS MERINO DANNA SARELA']
            ),
            createRow('e3-r2', 'UE Fiscal Manta', 
                ['DELGADO PINCAY ALEXANDRA MONSERRATE', 'ESCOBAR CEDEÑO DAVID JHADIER', 'MENENDEZ CHAVEZ ADRIAN ALBERTO', 'MUÑOZ ALCIVAR ASHLEY PIERINA'],
                ['ZAMBRANO SANCHEZ JURAIMA DANIELA', 'VALDIVIEZO ARTEAGA ARELYS ALEXANDRA', 'ZAMORA CEDEÑO JUAN SEBASTIAN', 'CASTRO CLARKE MAQUINTAIRE BRAD DOMINIQUE', 'QUIROZ LUCAS KARLA WALESKA']
            ),
            createRow('e3-r3', 'UE Fiscal 4 de Noviembre', 
                ['RAMOS CAYAMA NOHELY MARIANA', 'CHAVARRIA CARREÑO ASHLEY ROMINA', 'BARRE MERA ALIS LISETH', 'MENDOZA VINCES KRISTEL DAMARIS'],
                ['MENDOZA VINCES BIANCA DAMARIS', 'MOLINA LUCAS DAVID ISAAC', 'MUÑIZ MERA INGRID ANAHI', 'PICO DELGADO ANGELY VALERIA', 'MERO BAILON SANTIAGO SMITH']
            )
        ];

        const event4Data = [
            createRow('e4-r1', 'UE Julio Pierregrosse', 
                ['DELGADO CHACON SAMUEL JOSE', 'VARGAS CAICEDO MATHIAS JAVIER', 'REYES DELGADO LUIS MATHEUS', 'CEDEÑO DELGADO MARIA GABRIELA'],
                ['CASTELLANOS MUÑOZ BRAYDEN MIGUEL', 'VELASQUEZ PONCE ROLANDO ADRIAN', 'SANCHEZ DELGADO MARCELO RAPHAEL', 'MOREIRA CHAVEZ GIOVANNA MILENKA', 'GARCIA VALLE CESAR EMILIO']
            ),
            createRow('e4-r2', 'UE Israel', 
                ['ORTEGA CONFORME RAFELLA VALENTINA', 'ORDOÑEZ PAZMIÑO CAMILA ESTEFANÍA', 'ORTIZ AVILA PAOLO XAVIER', 'PARRAGA MOGROÑEDA ALLYSON EILENE'],
                ['LEITON MENDOZA DAIRA ABIGAIL', 'ZAMORA CERÓN DEREK ISAAC', 'OCHOA LIMONGI RICARDO', 'BILBAO LA VIEJA FARFAN CARLOS EDUARDO', 'PALMA FLORES YUSZETTY DAVID']
            ),
            createRow('e4-r3', 'UE Fiscal Pedro Balda', 
                ['ZAMBRANO MOREIRA DANNA JUSMELY', 'SANCHEZ GARCIA ESTHER ABIGAIL', 'PONCE MERA MELANIE MONSERRATE', 'MORAN ARAGUNDI KAREN GABRIELA'],
                ['SANCHEZ ALVARADO MEYSEE MAYTE', 'MEZA TOALA JOSENKA DOMENICA', 'BAJAÑA CEDEÑO DILEIDY JETSARI', 'CARDENAS CEVALLOS ASHLEY JELITZA', 'ZAMBRANO SABANDO DENISSE VALENTINA']
            ),
            createRow('e4-r4', 'UE Fiscal Tarqui - Matutina', 
                ['ALCIVAR ESPINALES GEMA VALENTINA', 'MERO ACOSTA JORGE LUIS', 'BARRETO CATAGUA MISHELLE ANAHI', 'BARRETO CHANCAY ALISSON DENISSE'],
                ['OLIVES ESPINALES LUCELY CHENOA', 'DELGADO BURGOS ADOLFO DANIEL', 'CASTRO FLORES MILENA MICHELLE', 'LEONES BRAVO GILEYMA DARLEY', 'BARRETO CHANCAY ALAN DAMIAN']
            ),
            createRow('e4-r5', 'UE Fiscal Tarqui - Vespertina', 
                ['SUAREZ CEDEÑO MELANY MONSERRATE', 'PAREDES VELEZ NAYELI ELIZABETH', 'CEDEÑO PALMA MADAY ADAIS', 'VERA CASTRO MARIA ISABEL'],
                ['CHAVEZTA BAZURTO KEYLA PIERINA', 'MACIAS MACIAS ANDREA CRISTINA', 'LOPEZ LOOR DAMARIS JULIETH', 'FIGUEROA ROMERO BRIANNA ANELIS', 'PALMA SOLEDISPA EMELY NAHOMY']
            )
        ];

        const EVENTS = [
          { id: 1, name: 'Sesión 1: Matutina', data: event1Data, color: 'blue' },
          { id: 2, name: 'Sesión 2: Matutina', data: event2Data, color: 'purple' },
          { id: 3, name: 'Sesión 3: Vespertina', data: event3Data, color: 'emerald' },
          { id: 4, name: 'Sesión 4: Vespertina', data: event4Data, color: 'orange' },
        ];

        const exportToExcelHTML = (data, fileName) => {
          const uniqueSessions = [...new Set(data.map(d => d.eventName))];
          const sessionTitle = uniqueSessions.length === 1 ? uniqueSessions[0] : "Reporte General";
          const date = new Date().toLocaleString();

          const tableContent = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head>
              <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
              <style>
                table { border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; }
                th { background-color: #1e3a8a; color: white; border: 1px solid #000; padding: 10px; text-align: center; }
                td { border: 1px solid #000; padding: 8px; vertical-align: middle; }
                .presente { color: #166534; font-weight: bold; text-align: center; }
                .ausente { color: #991b1b; text-align: center; }
              </style>
            </head>
            <body>
              <table>
                <thead>
                  <tr><th colspan="8" style="font-size: 14px; background-color: #f3f4f6; color: #000; text-align: left;">SESIÓN: ${sessionTitle} - FECHA: ${date}</th></tr>
                  <tr>
                    <th>Evento</th>
                    <th>Institución</th>
                    <th>Fila</th>
                    <th>Estudiante</th>
                    <th>Asiento</th>
                    <th>Dignidad</th>
                    <th>Bloque</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.map(row => `
                    <tr>
                      <td>${row.eventName}</td>
                      <td>${row.school}</td>
                      <td style="text-align:center">${row.rowId.split('-r')[1] || row.rowId}</td>
                      <td>${row.name}</td>
                      <td style="text-align:center">${row.pos}</td>
                      <td style="font-weight:bold">${row.dignity}</td>
                      <td style="text-align:center">${row.block}</td>
                      <td class="${row.status === 'PRESENTE' ? 'presente' : 'ausente'}">${row.status}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </body>
            </html>
          `;

          const blob = new Blob([tableContent], { type: 'application/vnd.ms-excel' });
          const link = document.createElement('a');
          link.href = window.URL.createObjectURL(blob);
          link.download = fileName.endsWith('.xls') ? fileName : `${fileName}.xls`;
          document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        const EventSelector = ({ onSelectEvent, onExportGlobal }) => (
          <div className="min-h-screen bg-gray-50 flex flex-col font-sans text-slate-800">
            <header className="bg-blue-900 text-white p-6 shadow-lg text-center">
              <h1 className="text-3xl font-bold text-yellow-400">UTPL - Gestión de Abanderados</h1>
              <p className="text-blue-200 mt-2">Seleccione la sesión para gestionar</p>
            </header>
            <main className="flex-grow p-6 flex flex-col items-center justify-center">
              <div className="w-full max-w-4xl mb-8 flex justify-end">
                 <button onClick={onExportGlobal} className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl shadow-md font-bold flex items-center gap-2"><FileSpreadsheet size={24}/> Reporte General (.xls)</button>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl w-full">
                {EVENTS.map(evt => (
                  <button key={evt.id} onClick={() => onSelectEvent(evt)} className={`group relative overflow-hidden p-8 rounded-2xl shadow-md border-2 text-left transition-all hover:shadow-xl hover:-translate-y-1 bg-white border-${evt.color}-100 hover:border-${evt.color}-500`}>
                    <div className="flex items-center gap-4 mb-4">
                      <div className={`p-3 rounded-full bg-${evt.color}-100 text-${evt.color}-600`}><Calendar size={32}/></div>
                      <h2 className="text-2xl font-bold text-gray-800">{evt.name}</h2>
                    </div>
                    <p className="text-gray-500 mb-6 pl-1">{evt.data.length} Filas registradas.</p>
                    <div className="flex items-center text-sm font-semibold text-gray-400 group-hover:text-gray-800 transition-colors">Ingresar <ChevronRight size={16}/></div>
                  </button>
                ))}
              </div>
            </main>
          </div>
        );

        const Seat = ({ seat, isSelected, isChecked, isDimmed, onClick }) => {
          if (seat.name === 'VACANTE') return <div className="w-12 h-12 m-1 opacity-0 pointer-events-none"></div>;
          let iconClass = "text-blue-200 fill-blue-50"; 
          let containerClass = "hover:scale-110";
          if (isSelected) { iconClass = "text-yellow-500 fill-yellow-200 drop-shadow-md"; containerClass = "scale-125 z-10"; }
          else if (isChecked) {
             if (isDimmed) { iconClass = "text-green-200 fill-green-50"; containerClass = ""; }
             else { iconClass = "text-green-600 fill-green-100"; }
          } else if (isDimmed) { iconClass = "text-gray-200 fill-gray-50"; containerClass = ""; }
          return (
            <div onClick={onClick} className={`relative flex flex-col items-center justify-center p-1 transition-all duration-300 cursor-pointer ${containerClass}`} title={`${seat.name}\n${seat.dignity}`}>
              <ChairIcon size={38} className={iconClass} fill={isChecked || isSelected ? "currentColor" : "none"} />
              <div className="absolute -top-1 -right-1 w-5 h-5 bg-white border border-gray-200 rounded-full flex items-center justify-center text-[10px] font-bold text-gray-600 shadow-sm z-20">{seat.pos}</div>
               {isChecked && !isSelected && !isDimmed && (<div className="absolute inset-0 flex items-center justify-center pointer-events-none z-20"><CheckCircle size={22} className="text-green-700 bg-white rounded-full p-0.5 shadow-sm" fill="currentColor"/></div>)}
            </div>
          );
        };

        const EventWorkspace = ({ event, checkedStudents, onToggleAttendance, onGoHome, onExportEvent, syncStatus }) => {
          const [searchTerm, setSearchTerm] = useState('');
          const [selectedStudent, setSelectedStudent] = useState(null);
          const seatingData = event.data;

          const normalize = (t) => t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
          const searchResults = useMemo(() => {
            if (!searchTerm || searchTerm.length < 2) return [];
            const term = normalize(searchTerm);
            let res = [];
            seatingData.forEach(r => {
              const check = (s) => { if(s.name!=='VACANTE' && normalize(s.name).includes(term)) res.push({...s, school:r.school, rowId:r.id}); };
              r.seatsLeft.forEach(check); r.seatsRight.forEach(check);
            });
            return res;
          }, [searchTerm, seatingData]);

          const handleSelectStudent = (s) => { setSelectedStudent(s); setSearchTerm(''); setTimeout(()=>document.getElementById('map-view').scrollIntoView({behavior:'smooth'}),100); };
          const checkedArray = useMemo(() => [...checkedStudents], [checkedStudents]);
          
          let totalSeats = 0;
          seatingData.forEach(r => {
             r.seatsLeft.forEach(s => {if(s.name!=='VACANTE') totalSeats++});
             r.seatsRight.forEach(s => {if(s.name!=='VACANTE') totalSeats++});
          });
          const eventIds = new Set();
          seatingData.forEach(r => { r.seatsLeft.forEach(s=>eventIds.add(s.id)); r.seatsRight.forEach(s=>eventIds.add(s.id)); });
          const presentCount = checkedArray.filter(id => eventIds.has(id)).length;
          const freeCount = totalSeats - presentCount;

          return (
            <div className="min-h-screen bg-gray-50 flex flex-col font-sans text-slate-800">
              <header className="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-50">
                <div className="max-w-7xl mx-auto flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <button onClick={onGoHome} className="p-2 hover:bg-blue-800 rounded-lg flex items-center gap-2 text-sm text-blue-200 hover:text-white"><ArrowLeft size={20}/><span className="hidden md:inline">Eventos</span></button>
                    <div>
                        <h1 className="text-xl font-bold text-yellow-400">{event.name}</h1>
                        <div className="flex items-center gap-2">
                            <p className="text-xs text-blue-200">Asientos</p>
                            {syncStatus && <span className="text-[10px] bg-blue-800 px-2 py-0.5 rounded-full text-green-300 font-bold border border-green-500/30 animate-pulse">{syncStatus}</span>}
                        </div>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                     <button onClick={onExportEvent} className="p-2 bg-green-600 hover:bg-green-700 rounded-lg text-white text-sm flex gap-1"><Download size={18}/><span className="hidden md:inline">Excel</span></button>
                     <div className="hidden md:flex flex-col items-end mx-2"><span className="text-xs font-semibold text-blue-200">ASISTENCIA</span><span className="text-xl font-bold">{presentCount}</span><span className="text-[10px] text-green-300">Libres: {freeCount}</span></div>
                     {selectedStudent && <button onClick={()=>setSelectedStudent(null)} className="p-2 bg-blue-800 rounded text-white"><X size={16}/></button>}
                  </div>
                </div>
              </header>

              <main className="flex-grow p-4 md:p-6 max-w-7xl mx-auto w-full">
                <div className="mb-6 max-w-3xl mx-auto relative z-40">
                   <div className="relative">
                      <input type="text" placeholder="Buscar estudiante..." className="w-full pl-10 pr-4 py-3 rounded-xl border border-blue-200 shadow-sm focus:border-yellow-400 focus:outline-none" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                      <div className="absolute left-3 top-3 text-gray-400"><Search size={20}/></div>
                   </div>
                   {searchResults.length > 0 && (
                      <div className="absolute top-full mt-2 w-full bg-white rounded-xl shadow-2xl border border-gray-100 overflow-hidden max-h-[50vh] overflow-y-auto z-50">
                         {searchResults.map(s => (
                            <button key={s.id} onClick={()=>handleSelectStudent(s)} className="w-full text-left px-4 py-3 hover:bg-blue-50 border-b border-gray-50 flex justify-between items-center">
                               <div><p className="font-bold text-gray-800 text-sm">{s.name}</p><p className="text-xs text-gray-500">{s.school}</p></div>
                               <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">{s.pos}</span>
                            </button>
                         ))}
                      </div>
                   )}
                </div>

                {selectedStudent && (
                   <div className="mb-6 bg-white border-l-4 border-yellow-400 p-4 rounded shadow-md flex flex-col md:flex-row items-center justify-between gap-4 animate-in fade-in slide-in-from-top-2">
                      <div className="flex items-start gap-3 flex-1">
                         <div className="bg-yellow-100 p-2 rounded-full text-yellow-700"><User size={24}/></div>
                         <div>
                            <h3 className="text-xs font-bold text-gray-400 uppercase">Estudiante Seleccionado</h3>
                            <p className="text-lg font-bold text-gray-900 leading-tight">{selectedStudent.name}</p>
                            <div className="flex flex-wrap gap-2 mt-1 text-sm text-blue-800 font-medium">
                                <span>{selectedStudent.school}</span>
                                <span>• Asiento {selectedStudent.pos}</span>
                            </div>
                            <div className="mt-2 flex items-center gap-2 text-xs font-bold text-yellow-600 bg-yellow-50 px-2 py-1 rounded border border-yellow-200 w-fit">
                                <Medal size={14}/> {selectedStudent.dignity}
                            </div>
                         </div>
                      </div>
                      <button onClick={()=>onToggleAttendance(selectedStudent.id)} className={`px-6 py-3 rounded-lg font-bold flex items-center gap-2 shadow-sm transition-all active:scale-95 ${checkedStudents.has(selectedStudent.id)?'bg-green-100 text-green-800 border border-green-300':'bg-yellow-400 text-yellow-900 hover:bg-yellow-300'}`}>
                         {checkedStudents.has(selectedStudent.id)?<><CheckCircle size={20}/> Presente</>:'Marcar Asistencia'}
                      </button>
                   </div>
                )}

                <div id="map-view" className="bg-white p-4 md:p-8 rounded-2xl shadow-xl border border-gray-200 overflow-x-auto">
                   <div className="min-w-[500px] mx-auto">
                      <div className="w-full bg-gray-800 text-gray-300 h-10 rounded mb-6 flex items-center justify-center font-bold text-xs uppercase shadow border-b-2 border-yellow-500">ESCENARIO ({event.name})</div>
                      <div className="flex mb-4 text-center text-xs font-bold text-gray-400 uppercase tracking-wider w-full">
                         <div className="w-28 flex-shrink-0"></div>
                         <div className="flex-grow-[4] basis-0 grid grid-cols-4 gap-1 mr-1">{[1,2,3,4].map(n=><div key={n}>A{n}</div>)}</div>
                         <div className="w-14"></div><div className="w-12"></div>
                         <div className="flex-grow-[5] basis-0 grid grid-cols-5 gap-1 ml-2">{[6,7,8,9,10].map(n=><div key={n}>A{n}</div>)}</div>
                      </div>
                      <div className="space-y-6 pb-48">
                         {seatingData.map(row => (
                            <div key={row.id} className="flex items-center w-full">
                               <div className={`w-28 flex-shrink-0 flex items-center pr-2 font-bold text-xs border-r border-gray-200 ${selectedStudent?.rowId===row.id?'text-blue-800':'text-gray-500'}`}>{row.school}</div>
                               <div className="flex-grow-[4] basis-0 grid grid-cols-4 gap-1 mr-1">
                                  {row.seatsLeft.map(s => <div key={s.id}><Seat seat={s} isSelected={selectedStudent?.id===s.id} isChecked={checkedStudents.has(s.id)} isDimmed={selectedStudent && selectedStudent.id!==s.id} onClick={()=>handleSelectStudent({...s, school:row.school, rowId:row.id})}/></div>)}
                               </div>
                               <div className="w-14 flex justify-center flex-shrink-0">{row.hasRector && <div className="w-full py-1 bg-slate-50 border rounded text-[8px] text-center font-bold text-slate-400">RECTOR</div>}</div>
                               <div className="w-12 flex justify-center flex-shrink-0"><div className="h-full border-l border-dashed border-gray-300"></div></div>
                               <div className="flex-grow-[5] basis-0 grid grid-cols-5 gap-1 ml-2">
                                  {row.seatsRight.map(s => <div key={s.id}><Seat seat={s} isSelected={selectedStudent?.id===s.id} isChecked={checkedStudents.has(s.id)} isDimmed={selectedStudent && selectedStudent.id!==s.id} onClick={()=>handleSelectStudent({...s, school:row.school, rowId:row.id})}/></div>)}
                               </div>
                            </div>
                         ))}
                      </div>
                      <div className="fixed bottom-6 right-6 bg-white/95 backdrop-blur shadow-xl border border-gray-200 p-4 rounded-xl text-xs space-y-2 z-50">
                         <h4 className="font-bold text-gray-800 mb-2">Leyenda</h4>
                         <div className="flex items-center gap-2"><div className="w-3 h-3 rounded bg-white border border-blue-200"></div> Libre</div>
                         <div className="flex items-center gap-2"><div className="w-3 h-3 rounded bg-green-500"></div> Presente</div>
                      </div>
                   </div>
                </div>
              </main>
            </div>
          );
        };

        const AbanderadosApp = () => {
          const [activeEvent, setActiveEvent] = useState(null);
          const [checkedStudents, setCheckedStudents] = useState(() => safeLoadStorage('utpl_asistencia_v2'));
          const [syncStatus, setSyncStatus] = useState(null);
          const syncTimeoutRef = useRef(null);

          useEffect(() => {
             const saveData = async () => {
                try {
                   localStorage.setItem('utpl_asistencia_v2', JSON.stringify([...checkedStudents]));
                   if (GOOGLE_SCRIPT_URL) {
                      setSyncStatus('⏳ Guardando...');
                      // 1. Recolectar TODO
                      let allData = [];
                      EVENTS.forEach(ev => ev.data.forEach(r => {
                         const add = (s) => s.name!=='VACANTE' && allData.push({
                            id: s.id, name: s.name, school: r.school, pos: s.pos, dignity: s.dignity,
                            status: checkedStudents.has(s.id) ? 'PRESENTE' : 'AUSENTE',
                            // Añadimos propiedades para ordenar
                            eventId: ev.id,
                            rowId: r.id
                         });
                         r.seatsLeft.forEach(add); r.seatsRight.forEach(add);
                      }));
                      
                      // 2. Filtrar SOLO PRESENTES
                      const onlyPresent = allData.filter(item => item.status === 'PRESENTE');

                      // 3. Ordenar: Primero por Evento, luego por Fila (Escuela), luego por Asiento
                      onlyPresent.sort((a, b) => {
                          if (a.eventId !== b.eventId) return a.eventId - b.eventId;
                          // Comparar strings de filas (ej: e1-r1 vs e1-r2)
                          if (a.rowId < b.rowId) return -1;
                          if (a.rowId > b.rowId) return 1;
                          return a.pos - b.pos;
                      });

                      await fetch(GOOGLE_SCRIPT_URL, {
                         method: 'POST',
                         mode: 'no-cors',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(onlyPresent) // Enviamos solo los presentes ordenados
                      });
                      setSyncStatus('✅ Sincronizado');
                      setTimeout(() => setSyncStatus(null), 3000);
                   }
                } catch(e) { console.error(e); setSyncStatus('⚠️ Error Sync'); }
             };
             if (syncTimeoutRef.current) clearTimeout(syncTimeoutRef.current);
             syncTimeoutRef.current = setTimeout(saveData, 2000);
             return () => clearTimeout(syncTimeoutRef.current);
          }, [checkedStudents]);

          const toggleAttendance = (id) => setCheckedStudents(prev => { const n = new Set(prev); n.has(id)?n.delete(id):n.add(id); return n; });

          const generateReport = (eventId) => {
             let data = [];
             const evts = eventId ? EVENTS.filter(e => e.id === eventId) : EVENTS;
             evts.forEach(e => e.data.forEach(r => {
                const add = (s, b) => s.name!=='VACANTE' && data.push({
                    eventName:e.name,school:r.school,rowId:r.id,name:s.name,pos:s.pos,dignity:s.dignity,block:b,status:checkedStudents.has(s.id)?'PRESENTE':'AUSENTE'
                });
                r.seatsLeft.forEach(s=>add(s,'Izquierda')); r.seatsRight.forEach(s=>add(s,'Derecha'));
             }));
             exportToExcelHTML(data, eventId ? `Asistencia_${evts[0].name}` : "Reporte_General_UTPL");
          };

          if (!activeEvent) return <EventSelector onSelectEvent={setActiveEvent} onExportGlobal={() => generateReport(null)} />;
          return <EventWorkspace event={activeEvent} checkedStudents={checkedStudents} onToggleAttendance={toggleAttendance} onGoHome={()=>setActiveEvent(null)} onExportEvent={()=>generateReport(activeEvent.id)} syncStatus={syncStatus} />;
        };

        const rootElement = document.getElementById('root');
        if (rootElement) ReactDOM.createRoot(rootElement).render(<AbanderadosApp />);
    </script>
</body>
</html>
